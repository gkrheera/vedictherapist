<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MVP Starter App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .auth-container button, .auth-container input {
            transition: all 0.2s ease-in-out;
        }
        .auth-container button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-md mx-auto bg-white rounded-xl shadow-md p-8">
            
            <!-- App Title -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-900">My Awesome MVP</h1>
                <p class="text-gray-500 mt-2">Welcome! Please sign in to continue.</p>
            </div>

            <!-- Authentication Section -->
            <div id="auth-section" class="space-y-6 auth-container">
                <!-- Logged Out State -->
                <div id="logged-out-view">
                    <div class="space-y-4">
                        <div>
                            <label for="email-input" class="text-sm font-medium text-gray-700">Email</label>
                            <input id="email-input" type="email" placeholder="you@example.com" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                         <div>
                            <label for="password-input" class="text-sm font-medium text-gray-700">Password</label>
                            <input id="password-input" type="password" placeholder="••••••••" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                        <div class="flex items-center justify-between space-x-4">
                            <button id="signin-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                Sign In
                            </button>
                             <button id="signup-btn" class="w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                Sign Up
                            </button>
                        </div>
                    </div>
                     <div id="auth-message" class="mt-4 text-center text-sm text-gray-600"></div>
                </div>

                <!-- Logged In State -->
                <div id="logged-in-view" class="hidden text-center">
                    <p class="mb-4">Welcome back! You are logged in as:</p>
                    <p id="user-email" class="font-medium text-indigo-600 bg-indigo-50 p-3 rounded-md"></p>
                    <button id="logout-btn" class="mt-6 w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        Logout
                    </button>
                </div>
            </div>

            <!-- Spacer -->
            <hr class="my-8 border-gray-200">
            
            <!-- Location Search Section -->
            <div id="location-section" class="hidden">
                 <h2 class="text-xl font-semibold text-center mb-4 text-gray-800">Location Search</h2>
                 <p class="text-center text-sm text-gray-500 mb-4">This feature is available after you log in.</p>
                <div class="relative">
                    <input type="text"
                           class="prokerala-location-input w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                           placeholder="Enter your location...">
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = 'https://wnmrbharvfaljfnjingq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndubXJiaGFydmZhbGpmbmppbmdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NDMwNDYsImV4cCI6MjA3MzMxOTA0Nn0.AgjPumfwwb0sE9PsCbAz-EpySVTy8CIh1_xMFjD2nt4';
        
        // --- INITIALIZATION ---
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log('Supabase client initialized.');

        // --- UI ELEMENT REFERENCES ---
        const loggedInView = document.getElementById('logged-in-view');
        const loggedOutView = document.getElementById('logged-out-view');
        const userEmailElement = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logout-btn');
        const locationSection = document.getElementById('location-section');
        const signInBtn = document.getElementById('signin-btn');
        const signUpBtn = document.getElementById('signup-btn');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const authMessage = document.getElementById('auth-message');

        // --- AUTHENTICATION FUNCTIONS ---

        // Sign up a new user
        async function signUpWithEmail() {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            if (!email || !password) {
                authMessage.textContent = 'Please enter both email and password.';
                authMessage.className = 'mt-4 text-center text-sm text-red-600';
                return;
            }

            console.log(`Attempting to sign up with email: ${email}`);
            authMessage.textContent = 'Signing up...';
            authMessage.className = 'mt-4 text-center text-sm text-gray-600';

            const { data, error } = await supabaseClient.auth.signUp({ email, password });

            if (error) {
                console.error('Sign up error:', error.message);
                authMessage.textContent = `Error: ${error.message}`;
                authMessage.className = 'mt-4 text-center text-sm text-red-600';
            } else {
                console.log('Sign up successful:', data);
                 // If the user object is not null but the session is, it means confirmation is required
                if (data.user && !data.session) {
                    authMessage.textContent = 'Sign up successful! Please check your email for a confirmation link.';
                    authMessage.className = 'mt-4 text-center text-sm text-green-600';
                } else {
                    // This case might happen if email confirmation is disabled
                     authMessage.textContent = 'Sign up successful! You are now logged in.';
                     authMessage.className = 'mt-4 text-center text-sm text-green-600';
                }
            }
        }

        // Sign in an existing user
        async function signInWithEmail() {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

             if (!email || !password) {
                authMessage.textContent = 'Please enter both email and password.';
                authMessage.className = 'mt-4 text-center text-sm text-red-600';
                return;
            }

            console.log(`Attempting to sign in with email: ${email}`);
            authMessage.textContent = ''; // Clear previous messages

            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

            if (error) {
                console.error('Sign in error:', error.message);
                authMessage.textContent = `Error: ${error.message}`;
                authMessage.className = 'mt-4 text-center text-sm text-red-600';
            } else {
                console.log('Sign in successful. Session:', data.session);
                // The onAuthStateChange handler will update the UI
            }
        }
        
        // Logout the current user
        async function signOut() {
            console.log('Attempting to sign out.');
            const { error } = await supabaseClient.auth.signOut();
            if (error) {
                console.error('Error signing out:', error.message);
            } else {
                console.log('Sign out successful.');
                // The onAuthStateChange handler will update the UI
            }
        }

        // --- UI UPDATE FUNCTION ---
        function updateUserUI(session) {
            if (session) {
                console.log('User is logged in. Updating UI.', session);
                loggedInView.classList.remove('hidden');
                loggedOutView.classList.add('hidden');
                locationSection.classList.remove('hidden');
                userEmailElement.textContent = session.user.email;
            } else {
                console.log('User is logged out. Updating UI.');
                loggedInView.classList.add('hidden');
                loggedOutView.classList.remove('hidden');
                locationSection.classList.add('hidden');
                userEmailElement.textContent = '';
                authMessage.textContent = '';
            }
        }

        // --- EVENT LISTENERS ---
        signUpBtn.addEventListener('click', signUpWithEmail);
        signInBtn.addEventListener('click', signInWithEmail);
        logoutBtn.addEventListener('click', signOut);

        // --- AUTH STATE CHANGE LISTENER ---
        // This is the core of the authentication logic. It listens for changes
        // (login, logout) and updates the UI accordingly.
        supabaseClient.auth.onAuthStateChange((event, session) => {
            console.log(`Auth event: ${event}`, session);
            updateUserUI(session);
        });

        // Initial check for a session when the page loads
        async function checkInitialSession() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            console.log('Initial session check:', session);
            updateUserUI(session);
        }

        // Run the initial check when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
             checkInitialSession();
        });

    </script>
    
    <!-- CODE FOR PROKERALA LOCATION SEARCH STARTS -->
    <script>
      (function () {
          // IMPORTANT: You must get a Client ID from prokerala.com/astrology/api/
          const CLIENT_ID = 'edba7407-3766-4bc1-a618-8ff8eacb034c'; 

          function loadScript(cb) {
              var script = document.createElement('script');
              script.src = 'https://client-api.prokerala.com/static/js/location.min.js';
              script.onload = cb;
              script.async = 1;
              document.head.appendChild(script);
          }

          function createInput(name, value) {
              const input = document.createElement('input');
              input.name = name;
              input.type = 'hidden';
              return input;
          }

          function initWidget(input) {
              const form = input.form;
              // This is a check to ensure we don't run this on a non-form element, though in this simple app it's not strictly necessary.
              if (!form) { 
                  console.warn('Location input is not inside a form element.');
                  return;
              }
              const inputPrefix = input.dataset.location_input_prefix ? input.dataset.location_input_prefix : '';
              const coordinates = createInput(inputPrefix + 'coordinates');
              const timezone = createInput(inputPrefix + 'timezone');
              form.appendChild(coordinates);
              form.appendChild(timezone);

              new LocationSearch(input, function (data) {
                  coordinates.value = `${data.latitude},${data.longitude}`;
                  timezone.value = data.timezone;
                  console.log('Location selected:', {
                      name: input.value,
                      coordinates: coordinates.value,
                      timezone: timezone.value
                  });
                  input.setCustomValidity('');
              }, {clientId: CLIENT_ID, persistKey: `${inputPrefix}loc`});

              input.addEventListener('change', function (e) {
                  // This provides a simple form validation message if the user types but doesn't select a valid location.
                  input.setCustomValidity('Please select a location from the suggestions list');
              });
          }

          loadScript(function() {
              console.log('Prokerala location script loaded.');
              let locationInputs = document.querySelectorAll('.prokerala-location-input');
              Array.from(locationInputs).map(initWidget);
          });
      })();
    </script>
    <!-- CODE FOR LOCATION SEARCH ENDS -->
</body>
</html>

